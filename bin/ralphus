#!/bin/bash
# Ralphus - Central execution wrapper for autonomous coding loops

set -euo pipefail

RALPHUS_HOME="${RALPHUS_HOME:-$HOME/ralphus}"
VARIANTS_DIR="$RALPHUS_HOME/variants"

show_help() {
    cat << 'EOF'
Usage: ralphus <command> [options]

Commands:
  <variant> [plan] [ulw] [N]   Run a variant loop
  help [variant]               Show detailed help

Variants:
EOF

    if [ -d "$VARIANTS_DIR" ]; then
        printf "  %-12s %s\n" "code" "Implement features from specs/"
        printf "  %-12s %s\n" "test" "Create tests from test-specs/"
        printf "  %-12s %s\n" "research" "Learn topics from questions/"
        printf "  %-12s %s\n" "discover" "Understand any codebase (no setup needed)"
    else
        echo "  (no variants found in $VARIANTS_DIR)"
    fi

    cat << EOF

Examples:
  ralphus code plan          Generate IMPLEMENTATION_PLAN.md
  ralphus code               Run build loop
  ralphus code ulw 20        Ultrawork mode, max 20 iterations
  ralphus discover plan      Generate DISCOVERY_PLAN.md
  ralphus discover           Explore codebase patterns
  ralphus help code          Show detailed help for 'code' variant

Environment:
  RALPHUS_HOME    $RALPHUS_HOME
  RALPH_AGENT     ${RALPH_AGENT:-Sisyphus}
  OPENCODE_BIN    ${OPENCODE_BIN:-opencode}
EOF
}

show_variant_help() {
    local variant="$1"
    local variant_dir="$VARIANTS_DIR/ralphus-$variant"
    
    if [ ! -d "$variant_dir" ]; then
        echo "Error: Unknown variant '$variant'"
        echo ""
        echo "Available variants: code, test, research, discover"
        exit 1
    fi

    case "$variant" in
        code)
            cat << 'EOF'
RALPHUS CODE - Feature Implementation

Implements features from specification files using an autonomous loop.

SETUP:
  1. Create specs/ directory with feature specifications
  2. Each spec is a markdown file describing what to build

USAGE:
  ralphus code plan     Generate IMPLEMENTATION_PLAN.md from specs/
  ralphus code          Run build loop (implements one task per iteration)
  ralphus code ulw      Ultrawork mode (aggressive, single-session)
  ralphus code 20       Limit to 20 iterations

REQUIRED FILES:
  specs/*.md            Feature specifications (you create these)

GENERATED FILES:
  IMPLEMENTATION_PLAN.md   Task tracking (generated by 'plan')

SPEC FORMAT:
  # Feature Name
  
  ## Requirements
  - User can do X
  - System responds with Y
  
  ## Acceptance Criteria
  - [ ] X works correctly
  - [ ] Y handles edge cases

COMPLETION SIGNALS:
  PLAN_COMPLETE     Planning done, run 'ralphus code'
  PHASE_COMPLETE    One task done, loop continues
  COMPLETE          All tasks done
  BLOCKED           Stuck, needs human help
EOF
            ;;
        test)
            cat << 'EOF'
RALPHUS TEST - Test Creation

Creates tests from test specification files, one test per iteration.

SETUP:
  1. Create test-specs/ directory with test specifications
  2. Each spec describes test cases to implement

USAGE:
  ralphus test plan     Prepare test spec with checkboxes
  ralphus test          Create tests one by one
  ralphus test ulw 50   Ultrawork mode, max 50 tests

REQUIRED FILES:
  test-specs/*.md       Test specifications (you create these)

GENERATED FILES:
  Tests in your project's test directory

SPEC FORMAT:
  # Component Tests
  
  ## Unit Tests
  - [ ] should handle empty input
  - [ ] should validate email format
  - [ ] should throw on invalid config
  
  ## Integration Tests
  - [ ] API returns 200 for valid request
  - [ ] Database transaction rolls back on error
EOF
            ;;
        research)
            cat << 'EOF'
RALPHUS RESEARCH - Deep Learning

Learns topics by answering questions and building knowledge artifacts.

SETUP:
  1. Create questions/ directory with research questions
  2. Each file contains questions about a topic to learn

USAGE:
  ralphus research plan    Create RESEARCH_PLAN.md
  ralphus research         Learn topics iteratively

REQUIRED FILES:
  questions/*.md           Research questions (you create these)

GENERATED FILES:
  RESEARCH_PLAN.md         Learning progress tracking
  knowledge/               Knowledge artifacts per topic
    {topic}/
      SUMMARY.md           ELI5 explanation
      QUIZ.md              Self-validation questions
      CONNECTIONS.md       How it relates to other topics

QUESTION FORMAT:
  # Quantum Computing
  
  ## Questions
  - What is a qubit?
  - How does superposition work?
  - What is quantum entanglement?
  
  ## Success Criteria
  I'll know I understand this when I can explain it to a 5-year-old.
EOF
            ;;
        discover)
            cat << 'EOF'
RALPHUS DISCOVER - Codebase Understanding

Systematically explores and documents a codebase. No setup required.

SETUP:
  None! Just run it in any git repository.

USAGE:
  ralphus discover plan    Generate DISCOVERY_PLAN.md (tailored to codebase)
  ralphus discover         Explore and document patterns
  ralphus discover 30      Limit to 30 discoveries

REQUIRED FILES:
  (none)                   Works on any codebase

GENERATED FILES:
  DISCOVERY_PLAN.md            Question tracking
  discoveries/*.md             Individual discoveries with evidence
  CODEBASE_UNDERSTANDING.md    Synthesized overview
  PATTERNS.md                  Catalog of patterns
  CONVENTIONS.md               Documented conventions
  GOTCHAS.md                   Tricks and tribal knowledge

DISCOVERY CATEGORIES:
  Architecture      Entry points, modules, dependencies
  Patterns          Design patterns, error handling, async
  Conventions       Naming, file organization, testing
  Data Flow         Entities, transformations, validation
  Tricks & Quirks   Workarounds, gotchas, optimizations

HOW IT WORKS:
  1. Plan phase scans codebase and generates tailored questions
  2. Each iteration answers ONE question deeply
  3. Each answer generates 1-2 follow-up questions (depth-first)
  4. Loop exhausts when 3 consecutive discoveries yield no follow-ups
  5. Synthesis phase creates summary documents
EOF
            ;;
        *)
            local readme="$variant_dir/README.md"
            if [ -f "$readme" ]; then
                cat "$readme"
            else
                echo "No detailed help available for '$variant'"
            fi
            ;;
    esac
}

# No arguments - show help
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

# Handle help command
if [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    if [ $# -gt 1 ] && [ "$2" != "--help" ]; then
        show_variant_help "$2"
    else
        show_help
    fi
    exit 0
fi

# Parse variant name
VARIANT="$1"
shift

# Resolve variant directory
VARIANT_DIR="$VARIANTS_DIR/ralphus-$VARIANT"
if [ ! -d "$VARIANT_DIR" ]; then
    echo "Error: Unknown variant '$VARIANT'"
    echo ""
    echo "Available variants: code, test, research, discover"
    echo ""
    echo "Run 'ralphus help' for usage information."
    exit 1
fi

# Verify loop.sh exists
LOOP_SCRIPT="$VARIANT_DIR/scripts/loop.sh"
if [ ! -f "$LOOP_SCRIPT" ]; then
    echo "Error: $LOOP_SCRIPT not found"
    exit 1
fi

# Execute with working directory context
export RALPHUS_WORKING_DIR="$(pwd)"
exec "$LOOP_SCRIPT" "$@"
