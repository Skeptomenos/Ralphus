#!/bin/bash
# Ralphus - Central execution wrapper for autonomous coding loops

set -euo pipefail

RALPHUS_HOME="${RALPHUS_HOME:-$HOME/ralphus}"
VARIANTS_DIR="$RALPHUS_HOME/variants"

# Dynamic variant discovery
get_variants() {
    if [ -d "$VARIANTS_DIR" ]; then
        find "$VARIANTS_DIR" -maxdepth 1 -name "ralphus-*" -type d | \
        sed 's|.*/ralphus-||' | sort
    fi
}

show_help() {
    cat << 'EOF'
Usage: ralphus <command> [options]

Commands:
  <variant> [plan] [ulw] [N]   Run a variant loop
  help [variant]               Show detailed help

Variants:
EOF

    if [ -d "$VARIANTS_DIR" ]; then
        for variant_dir in "$VARIANTS_DIR"/ralphus-*; do
            if [ -d "$variant_dir" ]; then
                variant_name=$(basename "$variant_dir" | sed 's/ralphus-//')
                loop_script="$variant_dir/scripts/loop.sh"
                description="Run $variant_name loop"
                
                # Try to extract description from loop.sh header
                # Looks for line: # Ralphus Name - Description
                if [ -f "$loop_script" ]; then
                    header=$(grep -m 1 "^# Ralphus" "$loop_script" || true)
                    if [ -n "$header" ]; then
                        description=$(echo "$header" | sed 's/.* - //')
                    fi
                fi
                
                printf "  %-12s %s\n" "$variant_name" "$description"
            fi
        done
    else
        echo "  (no variants found in $VARIANTS_DIR)"
    fi

    cat << EOF

Examples:
  ralphus code plan          Generate IMPLEMENTATION_PLAN.md
  ralphus code               Run build loop
  ralphus review plan pr     Plan PR review
  ralphus help code          Show detailed help for 'code' variant

Environment:
  RALPHUS_HOME    $RALPHUS_HOME
  RALPH_AGENT     ${RALPH_AGENT:-Sisyphus}
  OPENCODE_BIN    ${OPENCODE_BIN:-opencode}
EOF
}

show_variant_help() {
    local variant="$1"
    local variant_dir="$VARIANTS_DIR/ralphus-$variant"
    
    if [ ! -d "$variant_dir" ]; then
        echo "Error: Unknown variant '$variant'"
        echo ""
        echo "Available variants:"
        get_variants | sed 's/^/  /'
        exit 1
    fi

    local readme="$variant_dir/README.md"
    if [ -f "$readme" ]; then
        # Display the README
        if command -v glow >/dev/null 2>&1; then
            glow "$readme"
        else
            cat "$readme"
        fi
    else
        echo "No detailed help available for '$variant'"
        echo "Check $variant_dir for details."
    fi
}

# No arguments - show help
if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

# Handle help command
if [ "$1" = "help" ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    if [ $# -gt 1 ] && [ "$2" != "--help" ]; then
        show_variant_help "$2"
    else
        show_help
    fi
    exit 0
fi

# Parse variant name
VARIANT="$1"
shift

# Resolve variant directory
VARIANT_DIR="$VARIANTS_DIR/ralphus-$VARIANT"
if [ ! -d "$VARIANT_DIR" ]; then
    echo "Error: Unknown variant '$VARIANT'"
    echo ""
    echo "Available variants:"
    get_variants | sed 's/^/  /'
    echo ""
    echo "Run 'ralphus help' for usage information."
    exit 1
fi

# Verify loop.sh exists
LOOP_SCRIPT="$VARIANT_DIR/scripts/loop.sh"
if [ ! -f "$LOOP_SCRIPT" ]; then
    echo "Error: $LOOP_SCRIPT not found"
    exit 1
fi

# Execute with working directory context
export RALPHUS_WORKING_DIR="$(pwd)"
exec "$LOOP_SCRIPT" "$@"
