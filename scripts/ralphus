#!/bin/bash
# Ralphus - Central execution wrapper for autonomous coding loops
# Usage: ralphus <variant> [plan] [ulw] [max_iterations]
#
# Examples:
#   ralphus code plan      # Generate implementation plan
#   ralphus code           # Run build loop
#   ralphus test ulw 10    # Ultrawork test mode, max 10 iterations
#   ralphus discover       # Discover codebase patterns
#
# Environment:
#   RALPHUS_HOME    Central Ralphus installation (default: ~/ralphus)
#   RALPH_AGENT     OpenCode agent to use (default: Sisyphus)
#   OPENCODE_BIN    Path to OpenCode binary (default: opencode)

set -euo pipefail

RALPHUS_HOME="${RALPHUS_HOME:-$HOME/ralphus}"
VARIANTS_DIR="$RALPHUS_HOME/variants"

# Show help if no arguments or --help
if [ $# -eq 0 ] || [ "${1:-}" = "--help" ] || [ "${1:-}" = "-h" ]; then
    echo "Usage: ralphus <variant> [plan] [ulw] [max_iterations]"
    echo ""
    echo "Run Ralphus autonomous loops from any project directory."
    echo "Prompts and templates come from central installation."
    echo "Project files (specs, plans) are read from current directory."
    echo ""
    echo "Available variants:"
    if [ -d "$VARIANTS_DIR" ]; then
        for dir in "$VARIANTS_DIR"/ralphus-*/; do
            if [ -d "$dir" ]; then
                name=$(basename "$dir" | sed 's/ralphus-//')
                # Try to get description from README
                readme="$dir/README.md"
                if [ -f "$readme" ]; then
                    desc=$(head -5 "$readme" | grep -v "^#" | grep -v "^$" | head -1 | cut -c1-50)
                    echo "  $name - $desc"
                else
                    echo "  $name"
                fi
            fi
        done
    else
        echo "  (no variants found in $VARIANTS_DIR)"
    fi
    echo ""
    echo "Environment variables:"
    echo "  RALPHUS_HOME    $RALPHUS_HOME"
    echo "  RALPH_AGENT     ${RALPH_AGENT:-Sisyphus}"
    echo "  OPENCODE_BIN    ${OPENCODE_BIN:-opencode}"
    exit 0
fi

# Parse variant name
VARIANT="$1"
shift

# Resolve variant directory
VARIANT_DIR="$VARIANTS_DIR/ralphus-$VARIANT"
if [ ! -d "$VARIANT_DIR" ]; then
    echo "Error: Unknown variant '$VARIANT'"
    echo ""
    echo "Available variants:"
    for dir in "$VARIANTS_DIR"/ralphus-*/; do
        if [ -d "$dir" ]; then
            name=$(basename "$dir" | sed 's/ralphus-//')
            echo "  $name"
        fi
    done
    exit 1
fi

# Verify loop.sh exists
LOOP_SCRIPT="$VARIANT_DIR/scripts/loop.sh"
if [ ! -f "$LOOP_SCRIPT" ]; then
    echo "Error: $LOOP_SCRIPT not found"
    exit 1
fi

# Execute with working directory context
export RALPHUS_WORKING_DIR="$(pwd)"
exec "$LOOP_SCRIPT" "$@"
